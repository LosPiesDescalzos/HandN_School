# 3. Создание доменной модели

В результате выполнения лабораторной работы должна быть спроектирована модель данных, описывающая выбранную прикладную область..

Для выполнения данной лабораторной работы вам необходимо выбрать поставщика данных уровня баз данных. Рекомендуется воспользоваться любым Database as a Service решением, либо разрешается использовать любую выделенную реляционную СУБД. Далее будет рассмотрен вариант с подключением базы данных от хостинга Render.com.

Для того чтобы использовать базу данных Postgres в качестве СУБД необходимо выбрать соответствующий пункт в Dashboard панели хостинга Render

![](https://i.imgur.com/YYEML5J.png)

**Обратите внимание** на то, что сервис Render.com предоставляет бесплатныйдоступ к СУБД в ознакомительном режиме

![](https://i.imgur.com/oCCRZjA.png)

С момента создания базы данных у вас будет **3 месяца** для того чтобы сделать все последующие лабораторные работы. По истечению трёх месяцев база данных будет автоматически удалена.

Параметры создания базы данных предложенные Wizard’ом можно не менять, пользователь и название самой базы будет сгенерировано автоматически. В случае если вы хотите что-то кастомизировать, то это можно сделать согласно [документации](https://render.com/docs/databases) представленной хостингом.

После того как вы создадите экземпляр СУБД, вам будет предоставлено два URL’a. Один, который вы должны использовать непосредственно в задеплоенном на [render.com](http://render.com/) приложение и второй, который вы можете использовать для подключения со своей локальной машины.

![](https://i.imgur.com/NTIHGFe.png)

Проверьте что вы можете подключиться к созданной базе данных. 

Рекомендую использовать инструмент встроенный в WebStorm инструмент дублирующий функционал DataGrip’a. По-умолчанию он не включен в дистрибутив, поэтому установите пакет из маркетплейса самостоятельно.

![](https://i.imgur.com/hJDkjpU.png)

Подключение к Postgres не должно сильно отличаться от MSSQL, с которым вы уже имели опыт работы на курс ранее, просто в качестве клиента вы будете использовать IDE, а не отдельный инструмент.

![](https://i.imgur.com/3xUDEvs.png)

Если у вас получилось получить сообщение о том что подключение успешно установлено, то можно переходить к следующему шагу - подключению СУБД к вашему проекту.

Первым делом, необходимо добавить Connection String как переменную среды окружения для вашего приложения. Для этого зайдите в раздел **Environment** и создайте ключ `DATABASE_URL` как на изображении ниже

![](https://i.imgur.com/ITAkQUN.png)

Значение для этого ключа скопируйте из поля “Internal Database URL”.

Также добавьте соответствующий External Database URL для локальной конфигурации в ваш проект как на скриншоте ниже

![](https://i.imgur.com/NiZ6SXY.png)

т.к. используется Postgres, то необходимо добавить пакет ‘pg’ как зависимость (pg это ODBC для node.js):

```
npm install pg --save
```

Далее необходимо выбрать одну из поддерживаемых ORM для работы со слоем данных. Рекомендуется либо TypeORM либо Prisma.

### TypeORM

В случае, если вы используете TypeORM, вам понадобится распарсить connectionString к базе данных и предоставить её ORM’ке в том виде, как это описано в документации, в виде отдельных полей - `Host`, `username`, `password` и т.д. 

Для решения этой задачи рекомендую воспользоваться npm пакетом `pg-connection-string`. Ознакомьтесь с разделом [Async Configuration](https://docs.nestjs.com/techniques/database#async-configuration) и реализуйте сервис инфраструктурного слоя DDD для создания объекта необходимого ORM для подключения.

### Prisma

В случае, если вы используете Prisma, то connection string можно использовать as-is. В качестве инфраструктурного слоя необходимо создать файл schema.prisma и добавить в него указания поставщика и названия ключа переменной окружения - **env(DATABASE_URL)**

После подключения ORM, необходимо описать все модели необходимые для работы вашего проекта. Рекомендуется описывать сущности согласно DDD с использованием общего языка выбранной предметной области

Например, на примере UserModule из лекционного материала, если вы создаёте модуль для работы с пользователем, то выделяйте сущности по смыслу в отдельные директории (*src/%moduleName%/entities/%entityName%.ts*)

![](https://i.imgur.com/XEqNUlN.png)

Для того чтобы ваши сущности были обработаны TypeOrm’ом
необходимо добавить декторатор [`@Entity`](https://docs.nestjs.com/techniques/database#repository-pattern) согласно документации. 

Если в конфигурации ORM вы добавили поле `synchronize` со значением `true` то согласно правилу описаному в поле `"entities”:["src/**/entites/*.entity{.ts,.js}"]` все ваши сущности с этим декоратором будут автоматически мигрированы в базу данных.

Для Prisma ORM схема объявляется отдельно [согласно документации](https://docs.nestjs.com/recipes/prisma#create-two-database-tables-with-prisma-migrate).

![](https://i.imgur.com/V3TpUVO.png)

![](https://i.imgur.com/Ma1WCsp.png)

Сгенерируйте визуальное представление схемы вашей данных в виде ERD (диаграммы). Пример диаграммы в DataGrip представлен ниже:

![](https://i.imgur.com/F7L0FZK.png)

Полученную схему в виде ERD диаграммы загрузите в корень вашего репозитория и опишите значение сущностей (текстовое описание на русском языке) в файле readme.md